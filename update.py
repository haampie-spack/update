import re
import os
import random

import spack.repo
from llnl.util.filesystem import working_dir
from spack.util.executable import Executable

def is_allowed_version(v):
    return all(isinstance(x, int) for x in v.version)

def try_and_update(name):
    try:
        print("Checking {0}".format(name))
        pkg = spack.repo.get(name)
        versions = pkg.fetch_remote_versions()
        # filter versions that are > current max, and skip release candidates etc
        # todo: allow new patch versions of older minor versions
        current_max = max(pkg.versions.keys())
        keys = sorted([v for v in versions.keys() if v > current_max and is_allowed_version(v)], reverse=True)

        if len(keys) == 0:
            return

        print("- Considering {}".format(keys))

        filtered_map = {k: versions[k] for k in keys}
        result = spack.stage.get_checksums_for_versions(filtered_map, pkg.name, keep_stage=False, batch=True, fetch_options=pkg.fetch_options)
        packagedotpy = os.path.join(pkg.package_dir, "package.py")

        with open(packagedotpy, "r") as file:
            contents = file.read()

        regex = re.compile("    version\\(")
        replaced = regex.sub(result + "\n    version(", contents, 1)

        with open(packagedotpy, "w") as file:
            file.write(replaced)

        with working_dir(pkg.package_dir):
            Executable("git")("add", ".")
            Executable("git")("commit", "-m", "Add new versions of {0}".format(pkg.name))
    except:
        print("Failure updating {0}".format(name))

def main(packages):
    for pkgname in packages:
        try_and_update(pkgname)

if __name__ == "__main__":
    list_of_packages = [
        "python",
        "py-setuptools",
        "r",
        "cmake",
        "perl",
        "pkg-config",
        "pkgconf",
        "py-numpy",
        "zlib",
        "libtool",
        "autoconf",
        "automake",
        # "intel-parallel-studio",
        "openmpi",
        "m4",
        "nvhpc",
        "mpich",
        "mvapich2",
        "mvapich2-gdr",
        "mvapich2x",
        # "intel-oneapi-mpi",
        "spectrum-mpi",
        "mpilander",
        "mpt",
        "cray-mpich",
        "fujitsu-mpi",
        # "intel-mpi",
        "py-six",
        "boost",
        "icedtea",
        "jdk",
        "util-macros",
        "openjdk",
        "ibm-java",
        "libx11",
        "py-scipy",
        "r-rcpp",
        # "cuda",
        "py-matplotlib",
        "hdf5",
        "py-cython",
        "ncurses",
        "openssl",
        "py-azure-cli",
        # "qt",
        # "intel-mkl",
        "netlib-lapack",
        "r-seurat",
        # "intel-oneapi-mkl",
        "py-requests",
        "atlas",
        "libxml2",
        "root",
        "openblas",
        "r-ggplot2",
        "xproto",
        "py-msrest",
        "flexiblas",
        "cray-libsci",
        "fujitsu-ssl2",
        "veclibfort",
        "py-sphinx",
        "glib",
        "r-biobase",
        "bison",
        "py-azure-common",
        "py-msrestazure",
        "gdal",
        "flex",
        "curl",
        "r-mass",
        "gettext",
        "essl",
        "amdblis",
        "blis",
        "r-biocgenerics",
        "netlib-xblas",
        "fftw",
        "r-matrix",
        "amdlibflame",
        "libflame",
        "go",
        "libpng",
        "py-pyyaml",
        "geant4-data",
        "py-azure-mgmt-nspkg",
        "biopieces",
        "py-torch",
        "py-pandas",
        "gsl",
        # "git",
        "r-rlang",
        "r-magrittr",
        "libxt",
        "libxext",
        "r-dplyr",
        "py-pytest",
        "gmake",
        "netcdf-c",
        "bzip2",
        "ruby",
        "r-lattice",
        "perl-bioperl",
        "petsc",
        "gmp",
        "libjpeg",
        "readline",
        "py-setuptools-scm",
        "swig",
        "r-annotationdbi",
        "maven",
        "libjpeg-turbo",
        "r-s4vectors",
        "r-tibble",
        "mesa18",
        "r-iranges",
        "freetype",
        "py-tensorflow",
        "libxmu",
        "sqlite",
        "doxygen",
        "mesa",
        "py-dvc",
        "cairo",
        "trinity",
        "expat",
        "py-wheel",
        "trilinos",
        "opencv",
        "py-h5py",
        "paraview",
        "graphviz",
        "llvm",
        "r-jsonlite",
        "dealii",
        "samtools",
        "hip",
        "py-python-dateutil",
        "py-jinja2",
        "hwloc",
        "py-enum34",
        "r-scales",
        "r-genomicranges",
        "libxaw",
        "lbann",
        "blast-plus",
        "py-astropy",
        "xorg-server",
        "libxcb",
        "octave",
        "perl-libwww-perl",
        "vtk",
        "grass",
        "py-azureml-core",
        "gtkplus",
        "r-biostrings",
        "libtiff",
        "py-click",
        "ffmpeg",
        "r-survival",
        "r-tidyr",
        "pcre",
        "py-future",
        "sirius",
        "r-minfi",
        "qgis",
        "maker",
        "circos",
        "r-scater",
        "r-shiny",
        "perl-module-build",
        "mfem",
        "gaudi",
        "libiconv",
        "r-stringr",
        "py-pysam",
        "tcl",
        "util-linux-uuid",
        "r-sp",
        "r-igraph",
        "hsa-rocr-dev",
        "apple-libuuid",
        "libuuid",
        "ossp-uuid",
        "libsm",
        "py-pip",
        "py-pygments",
        "r-reshape2",
        "py-scikit-learn",
        "r-digest",
        "lammps",
        "py-gemini",
        "py-apache-beam",
        "netlib-scalapack",
        "py-ipython",
        "r-devtools",
        "py-horovod",
        "libxslt",
        "py-argparse",
        "ninja",
        "r-genomeinfodb",
        "amdscalapack",
        "protobuf",
        "texinfo",
        "r-affy",
        "htslib",
        "comgr",
        "r-genomicfeatures",
        "r-dbi",
        "libc",
        "py-mpi4py",
        "py-pillow-simd",
        "cp2k",
        "r-rcolorbrewer",
        "eigen",
        "r-plyr",
        "tcoffee",
        "py-pillow",
        "r-rsamtools",
        "r-httr",
        "r-yapsa",
        "gnuplot",
        "xz",
        "mpfr",
        "py-azure-cli-core",
        "thrift",
        "py-cryptography",
        "py-vcf-kit",
        "mariadb",
        "texlive",
        "phyluce",
        "r-r6",
        "geopm",
        "lua",
        "r-ape",
        "py-cffi",
        "py-ray",
        "binutils",
        "r-htmltools",
        "r-tidyverse",
        "xextproto",
        "llvm-amdgpu",
        "r-foreach",
        "r-ggbio",
        "r-hmisc",
        "hpctoolkit",
        "rust",
        "sst-elements",
        "r-matrixstats",
        "timemory",
        "r-knitr",
        "perl-moose",
        "py-pytz",
        "gnuradio",
        "fontconfig",
        "r-usethis",
        "geant4",
        "r-biocparallel",
        "py-tornado",
        "pango",
        "py-tqdm",
        "dbcsr",
        "r-mlinterfaces",
        "r-purrr",
        "r-data-table",
        "r-zoo",
        "numactl",
        "py-nbconvert",
        "py-jsonschema",
        "adios",
        "adios2",
        "opengl",
        "py-typing",
        "hmmer",
        "poppler",
        "py-notebook",
        "r-rsqlite",
        "strumpack",
        "r-phytools",
        "r-readr",
        "pulseaudio",
        "r-plotly",
        "r-testthat",
        "rocm-device-libs",
        "py-abipy",
        "r-variantannotation",
        "r-bsseq",
        "proj",
        "py-mikado",
        "gmsh",
        "draco",
        "libice",
        "r-msnbase",
        "py-or-tools",
        "postgresql",
        "r-summarizedexperiment",
        "openpbs",
        "gnutls",
        "perl-http-message",
        "r-spatialeco",
        "r-crayon",
        "elmerfem",
        "py-pipits",
        "r-ggmap",
        "r-aneufinder",
        "libzmq",
        "py-docutils",
        "libxi",
        "moab",
        "r-mvtnorm",
        "fenics",
        "py-networkx",
        "py-mg-rast-tools",
        "libxrender",
        "wrf",
        "r-rminer",
        "perl-test-cleannamespaces",
        "hydrogen",
        "elfutils",
        "casacore",
        "flux-core",
        "arpack-ng",
        "qmcpack",
        "py-biopython",
        "mxnet",
        "openfoam",
        "slurm",
        "plumed",
        "r-cluster",
        "py-spacy",
        "perl-uri",
        "py-futures",
        "libcuml",
        "py-protobuf",
        "superlu-dist",
        "zstd",
        "metis",
        "mysql",
        "py-pycbc",
        "cantera",
        "py-spyder",
        "polymake",
        "braker",
        "r-gviz",
        "py-sentry-sdk",
        "r-nlme",
        "gmt",
        "tau",
        "libffi",
        "r-enrichplot",
        "py-pytest-runner",
        "ocl-icd",
        "r-spdep",
        "flecsi",
        "hypre",
        "hpx",
        "py-torch-geometric",
        "gl2ps",
        "suite-sparse",
        "sundials",
        "r-affycoretools",
        "xerces-c",
        "r-tfbstools",
        "r-diagrammer",
        "guile",
        "r-reportingtools",
        "wireshark",
        "py-pyparsing",
        "r-curl",
        "libgcrypt",
        "py-flask",
        "r-deseq2",
        "rocblas",
        "axom",
        "py-jupyterhub",
        "gcc",
        "r-withr",
        "neovim",
        "gdl",
        "gromacs",
        "py-importlib-metadata",
        # "intel-tbb",
        "r-xml",
        "elemental",
        "ncl",
        "r-gridextra",
        "r-genefilter",
        "r-glue",
        "octopus",
        "cbtf-krell",
        "py-traitlets",
        "stat",
        "py-nose",
        "r-rmarkdown",
        "r-methylumi",
        "libpeas",
        "py-netket",
        "redundans",
        "hdf",
        "py-wandb",
        "r-biovizbase",
        "py-urllib3",
        "r-cner",
        "py-distributed",
        "googletest",
        "py-gpaw",
        "r-rtracklayer",
        "r-rgl",
        "gdk-pixbuf",
        "ascent",
        "magics",
        "r-broom",
        "r-ggpubr",
        "extrae",
        "gobject-introspection",
        "lhapdf",
        "unifyfs",
        "py-sqlalchemy",
        "r-nmf",
        "libxinerama",
        "herwig3",
        "py-psutil",
        "kitty",
        "py-sanic",
        "py-mdanalysis",
        "dihydrogen",
        "esmf",
        "r-ensembldb",
        "r-fpc",
        "py-decorator",
        "interproscan",
        "r-bh",
        "r-rms",
        "libgd",
        "kicad",
        "r-limma",
        "mumps",
        "perl-xml-parser",
        "sbml",
        "repeatmodeler",
        "nektar",
        "frontistr",
        "r-spatstat",
        "akantu",
        "caffe",
        "py-geeup",
        "phist",
        "r-car",
        "libgpg-error",
        "r-recipes",
        "parmetis",
        "subversion",
        "r-genomicalignments",
        "py-quast",
        "r-cli",
        "hepmc",
        "turbine",
        "conduit",
        "r-rnoaa",
        "lz4",
        "meep",
        "amp",
        "pagmo",
        "quinoa",
        "elsi",
        "r-annotate",
        "mapserver",
        "swipl",
        "caliper",
        "openfast",
        "elpa",
        "py-cartopy",
        "librom",
        "q-e-sirius",
        "scorep",
        "mofem-cephas",
        "r-allelicimbalance",
        "tasmanian",
        "amdfftw",
        "r-xvector",
        "mesa-glu",
        "libxrandr",
        "spla",
        "py-theano",
        "r-rstan",
        "dftbplus",
        "py-csvkit",
        "py-fava",
        "wxwidgets",
        "popt",
        "plplot",
        "libevent",
        "r-biomartr",
        "parallel-netcdf",
        "r-htmlwidgets",
        "bowtie2",
        "bowtie",
        "visit",
        "weechat",
        "quantum-espresso",
        "cardioid",
        "yambo",
        "r-lumi",
        "freeglut",
        "py-pybind11",
        "py-pil",
        "vasp",
        "nest",
        "xterm",
        "py-flake8",
        "ghostscript",
        "abinit",
        "libxau",
        "r-forecast",
        "gawk",
        "py-lxml",
        "motif",
        "r-geiger",
        "fujitsu-fftw",
        "r-delayedarray",
        "aomp",
        "cntk",
        "slate",
        "fenics-dolfinx",
        "scr",
        "r-corhmm",
        "r-phyloseq",
        "qbox",
        "r-ergm",
        "zoltan",
        "icu4c",
        "py-tensorboard",
        "openpmd-api",
        "steps",
        "libpcap",
        "xsdk",
        "butterflypack",
        "r-ggraph",
        "py-packaging",
        "r-phylostratr",
        "libelf",
        "valgrind",
        "kaldi",
        "r-complexheatmap",
        "py-libensemble",
        "emacs",
        "r-shortread",
        "libxft",
        "r-annotationhub",
        "py-pyarrow",
        "sst-macro",
        "py-labours",
        "imagemagick",
        "py-pyzmq",
        "pocl",
        "sst-core",
        "r-adegenet",
        "bml",
        "r-rpart",
        "dakota",
        "meson",
        "py-numba",
        "ghost",
        "eigenexa",
        "r-graph",
        "ucx",
        "perl-soap-lite",
        "r-sf",
        "scotch",
        "abyss",
        "aspell",
        "py-python-benedict",
        "r-wgcna",
        "sgpp",
        "r-lme4",
        "repeatmasker",
        "gnupg",
        "r-smoof",
        "r-rcurl",
        "mptensor",
        "geos",
        "py-colorama",
        "r-tidyselect",
        "r-rjava",
        "r-bsgenome",
        "py-agate",
        "libtirpc",
        "py-thinc",
        "py-scikit-image",
        "r-dbplyr",
        "bohrium",
        "py-aiohttp",
        "cdo",
        "perl-inline-c",
        "hpx5",
        "r-factominer",
        "r-vctrs",
        "flann",
        "py-spatialist",
        "r-oligoclasses",
        "r-roxygen2",
        "libxpm",
        "arrayfire",
        "libxfixes",
        "cryptsetup",
        "hpcc",
        "r-chemometrics",
        "py-dask",
        "r-gplots",
        "libarchive",
        "catalyst",
        "openmx",
        "siesta",
        "r-ampliqueso",
        "py-typing-extensions",
        "r-hh",
        "silo",
        "charmpp",
        "chombo",
        "r-biomart",
        "r-pkgmaker",
        "heffte",
        "itk"
    ]

    # shuffle to ensure we get updates even when there's timeouts etc
    random.shuffle(list_of_packages)

    main(list_of_packages)